#            _
#    _______| |__  _ __ ___
#   |_  / __| '_ \| '__/ __|
#  _ / /\__ \ | | | | | (__
# (_)___|___/_| |_|_|  \___|
#
# -----------------------------------------------------
# ML4W zshrc loader
# -----------------------------------------------------

# DON'T CHANGE THIS FILE

# You can define your custom configuration by adding
# files in ~/.config/zshrc
# or by creating a folder ~/.config/zshrc/custom
# with copies of files from ~/.config/zshrc
# You can also create a .zshrc_custom file in your home directory
# -----------------------------------------------------

# -----------------------------------------------------
# Load modular configuration
# -----------------------------------------------------

for f in ~/.config/zshrc/*; do
    if [ ! -d $f ]; then
        c=`echo $f | sed -e "s=.config/zshrc=.config/zshrc/custom="`
        [[ -f $c ]] && source $c || source $f
    fi
done




# --- AURA OS: TACTICAL DASHBOARD ---
export AURA_API_KEY="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"

# --- THE TWO-LINE TACTICAL HEADER ---
AURA_RAM=$(free -m | awk '/Mem:/ { printf("%3.1f%%", $3/$2*100) }')
AURA_DSK=$(df -h / | awk 'NR==2 {print $4}' | sed 's/G//')
AURA_UP=$(uptime -p | sed 's/up //; s/ hours/h/; s/ minutes/m/')

echo -e "\e[1;35m[Aura Strategist]\e[0m \e[1;32mfix\e[0m | \e[1;32maura\e[0m | \e[1;32msee\e[0m | \e[1;33midea\e[0m | \e[1;33mstudy\e[0m | \e[1;33mlookup\e[0m | \e[1;36mstatus\e[0m | \e[1;31msave\e[0m"
echo -e "\e[1;34m[Aura Fortress]  \e[0m \e[1;32mmatrix\e[0m | \e[1;32mpeek\e[0m | \e[1;32mvibe\e[0m | \e[1;31mpurge\e[0m | \e[1;33mRAM: ${AURA_RAM}\e[0m | \e[1;33mDSK: ${AURA_DSK}G\e[0m | \e[1;33mUp: ${AURA_UP}\e[0m"

ask_swarm() {
  local prompt=$(jq -n --arg msg "$*" '$msg')
  local persona=$(jq -r '.sys_prompt' ~/.aura_brain.json 2>/dev/null || echo "You are Aura.")
  curl -s https://openrouter.ai/api/v1/chat/completions \
    -H "Authorization: Bearer $AURA_API_KEY" \
    -H "Content-Type: application/json" \
    -d "{\"model\": \"openrouter/auto\", \"messages\": [{\"role\": \"system\", \"content\": \"$persona\"}, {\"role\": \"user\", \"content\": $prompt}]}" | jq -r '.choices[0].message.content // .error.message'
}

aura() {
  if [ -z "$1" ]; then
    echo -e "\e[1;35m[Aura]:\e[0m Standing by for Hukum."
    echo -n "> " ; read user_input
    ask_swarm "$user_input"
  else
    ask_swarm "$*"
  fi
}

fix() {
  if [ -z "$*" ]; then echo "Aura requires a target to analyze."; return; fi
  echo -e "\e[1;31m[!] BREACH DETECTED: $*\e[0m"
  local cmd_output=$(eval "$*" 2>&1)
  local exit_val=$?
  if [ $exit_val -ne 0 ]; then
    echo -e "\e[1;33m[Analyzing Weakness...]\e[0m"
    local diagnosis=$(ask_swarm "Command '$*' failed with '$cmd_output'. Analyze and give ONLY the fix command as the last line.")
    echo -e "\n\e[1;35m[Aura]:\e[0m $diagnosis"
    local suggested_fix=$(echo "$diagnosis" | tail -n 1)
    echo -e "\n\e[1;32m[Crush Error?]\e[0m Press Enter to execute: $suggested_fix"
    read -k 1 -s ; eval "$suggested_fix"
  else
    echo -e "\e[1;32m[+] Victory.\e[0m" ; echo "$cmd_output"
  fi
}

alias status='aura "Give me a strategic overview of the system state, Strategist."'
